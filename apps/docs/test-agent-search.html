<!DOCTYPE html>
<html>
<head>
    <title>Agent Search Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        button { margin: 5px; padding: 8px 15px; cursor: pointer; }
        iframe { width: 100%; height: 500px; border: 1px solid #ccc; margin-top: 10px; }
        .test-log { background-color: #f8f9fa; padding: 10px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîç AgentsReview Search Functionality Test</h1>
        
        <div class="test-section">
            <h3>üß™ Test Agent Search Functions</h3>
            <button onclick="testSearchFunctions()">Test Search Functions</button>
            <button onclick="testSearchClear()">Test Search Clear</button>
            <button onclick="testAgentVisibility()">Test Agent Visibility</button>
            <button onclick="runAllTests()">Run All Tests</button>
        </div>

        <div class="test-section">
            <h3>üìä Test Results</h3>
            <div id="testResults">Click a test button to see results...</div>
        </div>

        <div class="test-section">
            <h3>üñºÔ∏è AgentsReview Preview</h3>
            <iframe id="agentsFrame" src="index.html" onload="onFrameLoad()"></iframe>
        </div>
    </div>

    <script>
        let agentsFrame;
        let frameWindow;
        let frameDocument;

        function onFrameLoad() {
            agentsFrame = document.getElementById('agentsFrame');
            frameWindow = agentsFrame.contentWindow;
            frameDocument = agentsFrame.contentDocument || frameWindow.document;
            
            log('‚úÖ AgentsReview loaded in iframe');
            
            // Wait for initialization, then test
            setTimeout(() => {
                testSearchFunctions();
            }, 3000);
        }

        function log(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            resultsDiv.appendChild(div);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            console.log(message);
        }

        function testSearchFunctions() {
            log('üîç Testing search functions availability...');

            try {
                // Test if filterAgents function exists
                if (typeof frameWindow.filterAgents === 'function') {
                    log('‚úÖ window.filterAgents function found', 'success');
                } else {
                    log('‚ùå window.filterAgents function missing', 'error');
                    return;
                }

                // Test if search input exists
                const searchInput = frameDocument.getElementById('agent-search');
                if (searchInput) {
                    log('‚úÖ Agent search input found', 'success');
                } else {
                    log('‚ùå Agent search input not found', 'error');
                    return;
                }

                // Test if agent cards exist
                const agentCards = frameDocument.querySelectorAll('.agent-card');
                log(`‚úÖ Found ${agentCards.length} agent cards`, 'success');

                if (agentCards.length === 0) {
                    log('‚ö†Ô∏è No agent cards found - may need to switch to Library tab first', 'error');
                    
                    // Try to switch to Library tab
                    if (typeof frameWindow.showTab === 'function') {
                        frameWindow.showTab('library');
                        setTimeout(() => {
                            testSearchFunctions();
                        }, 1000);
                        return;
                    }
                }

            } catch (error) {
                log(`‚ùå Error during function test: ${error.message}`, 'error');
            }
        }

        function testSearchClear() {
            log('üßπ Testing search clear functionality...');

            try {
                // Switch to library tab first
                if (typeof frameWindow.showTab === 'function') {
                    frameWindow.showTab('library');
                }

                setTimeout(() => {
                    const searchInput = frameDocument.getElementById('agent-search');
                    if (!searchInput) {
                        log('‚ùå Search input not found', 'error');
                        return;
                    }

                    // Set search value and filter
                    searchInput.value = 'python';
                    frameWindow.filterAgents();
                    
                    setTimeout(() => {
                        let visibleAfterSearch = frameDocument.querySelectorAll('.agent-card:not([style*="none"])');
                        log(`üìä After search 'python': ${visibleAfterSearch.length} agents visible`);

                        // Clear search
                        searchInput.value = '';
                        frameWindow.filterAgents();
                        
                        setTimeout(() => {
                            let visibleAfterClear = frameDocument.querySelectorAll('.agent-card:not([style*="none"])');
                            log(`üìä After clear: ${visibleAfterClear.length} agents visible`);

                            if (visibleAfterClear.length > 0) {
                                log('‚úÖ Search clear working - agents are visible after clear', 'success');
                            } else {
                                log('‚ùå Search clear not working - no agents visible after clear', 'error');
                                
                                // Debug: check all agent cards
                                const allCards = frameDocument.querySelectorAll('.agent-card');
                                log(`üîç Debug: Total agent cards found: ${allCards.length}`);
                                
                                // Check their styles
                                allCards.forEach((card, index) => {
                                    if (index < 3) { // Log first 3 cards
                                        const style = card.getAttribute('style') || 'no style';
                                        log(`üîç Card ${index + 1} style: ${style}`);
                                    }
                                });
                            }
                        }, 500);
                    }, 500);
                }, 1000);

            } catch (error) {
                log(`‚ùå Error during search clear test: ${error.message}`, 'error');
            }
        }

        function testAgentVisibility() {
            log('üëÅÔ∏è Testing agent visibility...');

            try {
                // Make sure we're on the library tab
                if (typeof frameWindow.showTab === 'function') {
                    frameWindow.showTab('library');
                }

                setTimeout(() => {
                    const allCards = frameDocument.querySelectorAll('.agent-card');
                    const visibleCards = frameDocument.querySelectorAll('.agent-card:not([style*="none"])');
                    const hiddenCards = frameDocument.querySelectorAll('.agent-card[style*="none"]');

                    log(`üìä Total agent cards: ${allCards.length}`);
                    log(`üìä Visible agent cards: ${visibleCards.length}`);
                    log(`üìä Hidden agent cards: ${hiddenCards.length}`);

                    // Check if agents array exists
                    if (frameWindow.agents) {
                        log(`üìä window.agents array length: ${frameWindow.agents.length}`);
                    } else {
                        log('‚ö†Ô∏è window.agents array not found');
                    }

                    if (visibleCards.length > 0) {
                        log('‚úÖ Agent visibility test passed', 'success');
                    } else {
                        log('‚ùå Agent visibility test failed - no visible cards', 'error');
                    }
                }, 1000);

            } catch (error) {
                log(`‚ùå Error during visibility test: ${error.message}`, 'error');
            }
        }

        function runAllTests() {
            log('üöÄ Running all tests...');
            
            testSearchFunctions();
            
            setTimeout(() => {
                testAgentVisibility();
            }, 2000);
            
            setTimeout(() => {
                testSearchClear();
            }, 4000);
        }
    </script>
</body>
</html>